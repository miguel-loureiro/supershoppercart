<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FirebaseConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">supershopcart</a> &gt; <a href="index.source.html" class="el_package">com.supershopcart.config</a> &gt; <span class="el_source">FirebaseConfig.java</span></div><h1>FirebaseConfig.java</h1><pre class="source lang-java linenums">package com.supershopcart.config;

import com.google.api.core.ApiFuture;
import com.google.auth.oauth2.AccessToken;
import com.google.auth.oauth2.GoogleCredentials;
import com.google.cloud.firestore.*;
import com.google.firebase.FirebaseApp;
import com.google.firebase.FirebaseOptions;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Profile;
import org.springframework.core.io.Resource;
import org.springframework.core.io.ResourceLoader;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.Base64;
import java.util.Collections;
import java.util.Date;
import java.util.Map;

@Configuration
public class FirebaseConfig {

<span class="fc" id="L29">    private static final Logger logger = LoggerFactory.getLogger(FirebaseConfig.class);</span>

    // --- Emulator Configuration Properties ---
    @Value(&quot;${firebase.project.id.emulator:fir-supershopcart-test}&quot;)
    private String emulatorProjectIdProp;

    @Value(&quot;${firebase.emulator.host:localhost:8081}&quot;)
    private String emulatorHostProp;

    // --- Production Configuration Properties ---
    @Value(&quot;${firebase.project.id:supershoppercart}&quot;)
    private String productionProjectIdProp;

    // This property is for a local dev setup where the key might still be on the classpath.
    // In production, we prefer the environment variable below.
    @Value(&quot;${firebase.service.account.path:classpath:firebase-service-account-prod.json}&quot;)
    private String serviceAccountPathProp;

    // --- New Environment Variable for Production Secret ---
    @Value(&quot;${FIREBASE_SERVICE_ACCOUNT_B64:}&quot;)
    private String serviceAccountB64;

    private final ResourceLoader resourceLoader;

<span class="fc" id="L53">    public FirebaseConfig(ResourceLoader resourceLoader) {</span>
<span class="fc" id="L54">        this.resourceLoader = resourceLoader;</span>
<span class="fc" id="L55">    }</span>

    // Custom NoCredentials class for emulator connection (same as your working test)
    static class NoCredentials extends GoogleCredentials {
<span class="fc" id="L59">        private static final NoCredentials INSTANCE = new NoCredentials();</span>

        private NoCredentials() {
        }

        public static NoCredentials getInstance() {
<span class="fc" id="L65">            return INSTANCE;</span>
        }

        @Override
        public AccessToken refreshAccessToken() throws IOException {
<span class="nc" id="L70">            return new AccessToken(&quot;dummy-token&quot;, new Date(Long.MAX_VALUE));</span>
        }
    }

    /**
     * Configures and provides a Firestore client bean for the local emulator.
     * This bean is active only when the &quot;dev-emulator&quot; Spring profile is active.
     */
    @Bean
    @Profile(&quot;dev-emulator&quot;)
    public Firestore firestoreEmulator() {
<span class="fc" id="L81">        logger.info(&quot;üöÄ Configuring Firestore for 'dev-emulator' profile...&quot;);</span>

<span class="fc" id="L83">        String projectId = emulatorProjectIdProp;</span>
<span class="fc" id="L84">        String envEmulatorHost = System.getenv(&quot;FIRESTORE_EMULATOR_HOST&quot;);</span>
        String finalEmulatorHost;

        // Prefer environment variable if set, otherwise use property
<span class="pc bpc" id="L88" title="3 of 4 branches missed.">        if (envEmulatorHost != null &amp;&amp; !envEmulatorHost.isBlank()) {</span>
<span class="nc" id="L89">            finalEmulatorHost = envEmulatorHost;</span>
<span class="nc" id="L90">            logger.info(&quot;Using FIRESTORE_EMULATOR_HOST environment variable: '{}'&quot;, envEmulatorHost);</span>
        } else {
<span class="fc" id="L92">            finalEmulatorHost = emulatorHostProp;</span>
<span class="fc" id="L93">            logger.info(&quot;Using firebase.emulator.host property: '{}'&quot;, emulatorHostProp);</span>
        }

<span class="fc" id="L96">        logger.info(&quot;Project ID for emulator: '{}'&quot;, projectId);</span>
<span class="fc" id="L97">        logger.info(&quot;Final emulator host: '{}'&quot;, finalEmulatorHost);</span>

        try {
<span class="fc bfc" id="L100" title="All 2 branches covered.">            if (FirebaseApp.getApps().isEmpty()) {</span>
<span class="fc" id="L101">                FirebaseOptions options = FirebaseOptions.builder()</span>
<span class="fc" id="L102">                        .setCredentials(NoCredentials.getInstance())</span>
<span class="fc" id="L103">                        .setProjectId(projectId)</span>
<span class="fc" id="L104">                        .build();</span>
<span class="fc" id="L105">                FirebaseApp.initializeApp(options);</span>
            }

<span class="fc" id="L108">            FirestoreOptions firestoreOptions = FirestoreOptions.newBuilder()</span>
<span class="fc" id="L109">                    .setProjectId(projectId)</span>
<span class="fc" id="L110">                    .setEmulatorHost(finalEmulatorHost)</span>
<span class="fc" id="L111">                    .setCredentials(NoCredentials.getInstance())</span>
<span class="fc" id="L112">                    .build();</span>

<span class="fc" id="L114">            return firestoreOptions.getService();</span>
<span class="fc" id="L115">        } catch (Exception e) {</span>
<span class="fc" id="L116">            logger.error(&quot;‚ùå Failed to configure Firestore client for emulator. ProjectId: '{}'. Error: {}&quot;,</span>
<span class="fc" id="L117">                    projectId, e.getMessage(), e);</span>
<span class="fc" id="L118">            throw new IllegalStateException(&quot;Could not create Firestore client for emulator - &quot; + e.getMessage(), e);</span>
        }
    }

    /**
     * Configures and provides a Firestore client bean for the production environment.
     * This bean is active when the &quot;dev-emulator&quot; Spring profile is NOT active.
     */
    @Bean
    @Profile(&quot;!dev-emulator&quot;)
    public Firestore firestoreProduction() throws IOException {
<span class="fc" id="L129">        logger.info(&quot;üöÄ Configuring Firestore for PRODUCTION profile...&quot;);</span>

        // Ensure FIRESTORE_EMULATOR_HOST environment variable is NOT set for production
<span class="fc" id="L132">        String envEmulatorHost = System.getenv(&quot;FIRESTORE_EMULATOR_HOST&quot;);</span>
<span class="pc bpc" id="L133" title="3 of 4 branches missed.">        if (envEmulatorHost != null &amp;&amp; !envEmulatorHost.isBlank()) {</span>
<span class="nc" id="L134">            logger.warn(&quot;WARNING: FIRESTORE_EMULATOR_HOST environment variable is set to '{}' in production profile. &quot; +</span>
                    &quot;This could cause unintended connections to an emulator. Please unset it for production.&quot;, envEmulatorHost);
        }

        // Initialize credentials based on the environment variable first.
        GoogleCredentials credentials;
        try {
<span class="pc bpc" id="L141" title="1 of 4 branches missed.">            if (serviceAccountB64 != null &amp;&amp; !serviceAccountB64.isBlank()) {</span>
<span class="fc" id="L142">                logger.info(&quot;Using service account key from FIREBASE_SERVICE_ACCOUNT_B64 environment variable.&quot;);</span>
<span class="fc" id="L143">                byte[] decodedBytes = Base64.getDecoder().decode(serviceAccountB64);</span>
<span class="fc" id="L144">                credentials = GoogleCredentials.fromStream(new ByteArrayInputStream(decodedBytes));</span>
<span class="fc" id="L145">            } else {</span>
<span class="fc" id="L146">                logger.warn(&quot;FIREBASE_SERVICE_ACCOUNT_B64 not found. Falling back to service account file path: '{}'&quot;, serviceAccountPathProp);</span>
<span class="fc" id="L147">                Resource resource = resourceLoader.getResource(serviceAccountPathProp);</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">                if (!resource.exists()) {</span>
<span class="fc" id="L149">                    logger.error(&quot;CRITICAL ERROR: Firebase service account file not found at: '{}'&quot;, serviceAccountPathProp);</span>
<span class="fc" id="L150">                    throw new IOException(&quot;Firebase service account file not found at: &quot; + serviceAccountPathProp);</span>
                }
<span class="fc" id="L152">                credentials = GoogleCredentials.fromStream(resource.getInputStream());</span>
            }

            // Initialize FirebaseApp only once
<span class="fc bfc" id="L156" title="All 2 branches covered.">            if (FirebaseApp.getApps().isEmpty()) {</span>
<span class="fc" id="L157">                FirebaseOptions options = FirebaseOptions.builder()</span>
<span class="fc" id="L158">                        .setCredentials(credentials)</span>
<span class="fc" id="L159">                        .setProjectId(productionProjectIdProp)</span>
<span class="fc" id="L160">                        .build();</span>
<span class="fc" id="L161">                FirebaseApp.initializeApp(options);</span>
<span class="fc" id="L162">                logger.info(&quot;FirebaseApp initialized for production environment.&quot;);</span>
<span class="fc" id="L163">            } else {</span>
<span class="fc" id="L164">                logger.info(&quot;FirebaseApp already initialized for production.&quot;);</span>
            }

            // Create and return Firestore instance
<span class="fc" id="L168">            Firestore firestore = FirestoreOptions.newBuilder()</span>
<span class="fc" id="L169">                    .setProjectId(productionProjectIdProp)</span>
<span class="fc" id="L170">                    .setCredentials(credentials)</span>
<span class="fc" id="L171">                    .build().getService();</span>

<span class="fc" id="L173">            logger.info(&quot;‚úÖ Firestore client initialized for PRODUCTION. Host: '{}', Project ID: '{}'&quot;,</span>
<span class="fc" id="L174">                    firestore.getOptions().getHost(), firestore.getOptions().getProjectId());</span>
<span class="fc" id="L175">            return firestore;</span>
<span class="fc" id="L176">        } catch (IOException e) {</span>
<span class="fc" id="L177">            logger.error(&quot;CRITICAL ERROR: Error initializing FirebaseApp for production: {}&quot;, e.getMessage(), e);</span>
<span class="fc" id="L178">            throw e;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>